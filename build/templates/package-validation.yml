parameters:
- name: arguments
  type: string
  default: ''

- name: projectName
  type: string
  default: ''

- name: net7_workloads
  type: string
  default: ''

- name: net8_workloads
  type: string
  default: ''

- name: install_net7
  type: boolean
  default: false

- name: install_net8
  type: boolean
  default: false

steps:

- task: UseDotNet@2
  displayName: 'Use .NET 7 SDK'
  inputs:
    version: '7.0.400'
  condition: and(succeeded(), eq(${{ parameters.install_net7 }}, true))

- task: UseDotNet@2
  displayName: 'Use .NET 8 SDK'
  inputs:
    version: '8.0.100-rc.1.23463.5'
  condition: and(succeeded(), eq(${{ parameters.install_net8 }}, true))

- powershell: |
    & dotnet workload install ${{ parameters.net7_workloads }} --from-rollback-file https://maui.blob.core.windows.net/metadata/rollbacks/7.0.92.json --skip-sign-check
  condition: and(succeeded(), ne('${{ parameters.net7_workloads }}', ''))
  displayName: Install .NET 7 workloads

- powershell: |
    & dotnet workload install ${{ parameters.net8_workloads }} --from-rollback-file https://maui.blob.core.windows.net/metadata/rollbacks/8.0.0-rc.1.9171.json --skip-sign-check
  condition: and(succeeded(), ne('${{ parameters.net8_workloads }}', ''))
  displayName: Install .NET 8 workloads

- powershell: |
      Set-PSDebug -Trace 1
      $ErrorActionPreference = 'Stop'

      # Create app with defaults
      dotnet new unoapp -skip -o ${{ parameters.projectName }} ${{ parameters.arguments }}
      if ($LASTEXITCODE -ne 0)
      {
          throw "Exit code must be zero."
      }

  displayName: Create template app

- template: canary-updater.yml
  parameters:
    MergeBranch: false

# Enabling hard links should result in faster builds. See https://github.com/dotnet/msbuild/issues/3788
- powershell: |
      Set-PSDebug -Trace 1
      $ErrorActionPreference = 'Stop'

      cd ${{ parameters.projectName }}

      & dotnet build ${{ parameters.projectName }}.sln -p:CreateHardLinksForCopyFilesToOutputDirectoryIfPossible=true -p:CreateHardLinksForCopyAdditionalFilesIfPossible=true -p:CreateHardLinksForCopyLocalIfPossible=true -p:CreateHardLinksForPublishFilesIfPossible=true "/bl:$(build.artifactstagingdirectory)\$(Agent.JobName)_${{ parameters.projectName }}.binlog"
      if ($LASTEXITCODE -ne 0)
      {
          throw "Exit code must be zero."
      }

  displayName: Build template app
